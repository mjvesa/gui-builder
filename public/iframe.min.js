window.onmessage=event=>{const command=event.data.command;if("render"===command){const el=document.querySelector("#canvas > div");window.Comod.render(event.data.tag,event.data.tree,el)}else if("get_element_coordinates_for_id"===command){const bcr=document.querySelector(`[data-node-id="${event.data.id}"]`).getBoundingClientRect();parent.postMessage({command:"element",token:event.data.token,left:bcr.left,top:bcr.top,width:bcr.width,height:bcr.height},"*")}else if("get_element_coordinates_for_point"===command){const el=document.elementFromPoint(event.data.x,event.data.y);if(el){const bcr=el.getBoundingClientRect();parent.postMessage({command:"element",token:event.data.token,id:el.getAttribute("data-node-id"),left:bcr.left,top:bcr.top,width:bcr.width,height:bcr.height},"*")}else parent.postMessage({command:"element",token:event.data.token,id:"-1"},"*")}else if("get_palette_content"===command)parent.postMessage({command:"palette_content",token:event.data.token,paletteContent:window.Comod.palette},"*");else if("get_file_extensions"===command)parent.postMessage({command:"get_file_extensions",token:event.data.token,fileExtensions:window.Comod.fileExtensions},"*");else if("parse_component"===command){const content=event.data.content,fileInfo=event.data.fileInfo,tree=window.Comod.parse(fileInfo.tag,content,fileInfo.path);tree&&parent.postMessage({command:"return_component",token:event.data.token,fileInfo:event.data.fileInfo,tree:tree},"*")}else if("update_component"===command){const{tag:tag,currentComponentSrc:currentComponentSrc,updatedComponent:updatedComponent}=event.data;parent.postMessage({command:"return_updated_component",token:event.data.token,updatedComponentSrc:window.Comod.update(tag,updatedComponent.tree,currentComponentSrc),updatedComponent:updatedComponent})}},document.body.onclick=event=>{let id=event.target.getAttribute("data-node-id"),el=event.target;for(;!id&&el&&el!==document.body;)el=el.parentElement,id=el.getAttribute("data-node-id");parent.postMessage({command:"select",id:id},"*"),event.stopPropagation(),event.preventDefault()};const body=document.body;body.draggable=!0,body.ondragstart=event=>{let el=document.elementFromPoint(event.clientX,event.clientY);for(;el&&el!==document.body&&!el.getAttribute("data-node-id");)el=el.parentElement;el&&el.getAttribute("data-node-id")&&(event.dataTransfer.setData("text/html",null),parent.postMessage({command:"dragstart",id:el.getAttribute("data-node-id")},"*")),event.stopPropagation()},body.ondragover=event=>{const el=document.elementFromPoint(event.clientX,event.clientY);if(el&&el.getAttribute("data-node-id")){const bcr=el.getBoundingClientRect();parent.postMessage({command:"drag",id:el.getAttribute("data-node-id"),x:event.clientX,y:event.clientY,left:bcr.left,top:bcr.top,width:bcr.width,height:bcr.height},"*")}event.preventDefault(),event.stopPropagation()},body.ondrop=event=>{parent.postMessage({command:"drop"},"*"),event.preventDefault()};
